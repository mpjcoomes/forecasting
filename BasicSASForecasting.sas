LIBNAME TSWORK 'C:\BasicSAS';
OPTIONS NOCENTER PAGESIZE=150 LINESIZE=256;
DATA DATETRANS_ARRDEP;
	SET TSWORK.ARRDEP;
	DATE=INTNX('MONTH','1dec1975'd, _N_ );
	FORMAT DATE MMYYS.;
	SQRT_STD=SQRT(STD);
	LOG_STD=LOG(STD);
	LABEL SQRT_STD="Square Root of STD" LOG_STD="Log e of STD";
RUN;

ODS RTF FILE="MYFILE.rtf" STYLE=Styles.MYWAY1;
ODS GRAPHICS ON / RESET border=off HEIGHT=10CM;

GOPTIONS CSYMBOL=BLACK HSIZE=27cm FBY=TIMES FTEXT=TIMES FTITLE=TIMES;
AXIS1 LENGTH=100 OFFSET=(0) VALUE=(FONT=TIMES HEIGHT=2pct) LABEL=(FONT=TIMES HEIGHT=3pct);
AXIS2 OFFSET=(0) VALUE=(FONT=TIMES HEIGHT=2pct) LABEL=(FONT=TIMES ANGLE=90 HEIGHT=3pct);
SYMBOL VALUE=NONE COLOR=BLACK CI=BLACK INTERPOL=JOIN WIDTH=2;
PROC GPLOT DATA=DATETRANS_ARRDEP;
	FOOTNOTE FONT=ITALIC JUSTIFY=LEFT HEIGHT=3pct "Figure 1: Short Term Departures by Month";
	PLOT STD*DATE / HAXIS=AXIS1 VAXIS=AXIS2;
RUN; FOOTNOTE;

AXIS3 OFFSET=(0) ORDER=(8 TO 14) VALUE=(FONT=TIMES HEIGHT=2pct) LABEL=(FONT=TIMES ANGLE=90 HEIGHT=3pct);
AXIS4 OFFSET=(0) ORDER=(200 TO 1000 BY 100) VALUE=(FONT=TIMES HEIGHT=2pct) LABEL=(FONT=TIMES ANGLE=90 HEIGHT=3pct);
LEGEND1 MODE=SHARE POSITION=(TOP LEFT INSIDE) SHAPE=LINE(3)cm VALUE=(FONT=TIMES HEIGHT=3pct) LABEL=(FONT=TIMES HEIGHT=3pct POSITION=TOP 'Transformation') OFFSET=(4,-2);
LEGEND2 MODE=SHARE POSITION=(TOP LEFT INSIDE) SHAPE=LINE(3)cm VALUE=(FONT=TIMES HEIGHT=3pct) LABEL=(FONT=TIMES HEIGHT=3pct POSITION=TOP '') OFFSET=(4,-6.5);
SYMBOL1 VALUE=NONE CI=BLACK INTERPOL=JOIN WIDTH=2 LINE=1;
SYMBOL2 VALUE=NONE CI=BLACK INTERPOL=JOIN WIDTH=3 LINE=2;
PROC GPLOT DATA=DATETRANS_ARRDEP;
	FOOTNOTE FONT=ITALIC JUSTIFY=LEFT HEIGHT=3pct "Figure 2: Square Root, LOG(e) Transformation Comparison";
	PLOT LOG_STD*DATE / OVERLAY HAXIS=AXIS1 VAXIS=AXIS3 LEGEND=LEGEND1;
	PLOT2 SQRT_STD*DATE / OVERLAY VAXIS=AXIS4 LEGEND=LEGEND2;
RUN; FOOTNOTE;

PROC REG DATA=DATETRANS_ARRDEP OUTEST=EST OUTVIF PLOTS(ONLY)=(fit DIAGNOSTICS(STATS=ALL) OBSERVEDBYPREDICTED RESIDUALBYPREDICTED RSTUDENTBYPREDICTED QQPLOT RESIDUALHISTOGRAM COOKSD);
	MODEL LOG_STD = month jan feb mar apr may jun jul aug sep oct nov dec / SELECTION=STEPWISE DW TOL VIF EDF AIC BIC CP SBC ;
	OUTPUT OUT=REGRESSION RESIDUAL=REG_RES PREDICTED=REG_PRED STDI=STDI LCL=REG_LCL UCL=REG_UCL;
RUN; QUIT; PROC PRINT DATA=EST; RUN;
PROC SGPLOT DATA=REGRESSION;
	FOOTNOTE JUSTIFY=LEFT ITALIC "Figure 3: Fit Testing, Residuals by Date with LOESS";
	REFLINE 0 / AXIS=y LINEATTRS=(COLOR=BLACK PATTERN=2);
	LOESS X=DATE Y=REG_RES / MARKERATTRS=(COLOR=BLACK) LINEATTRS=(COLOR=BLACK) ALPHA=.05 CLM LEGENDLABEL="LOESS" NAME="LINE1";
	KEYLEGEND "LINE1" / NOBORDER LOCATION=INSIDE POSITION=BOTTOM;
RUN; FOOTNOTE;

DATA ARRDEP_ARIMA;
	SET TSWORK.ARRDEP;
	DATE=INTNX('MONTH','1dec1975'd, _N_ );
	FORMAT DATE MMYYS.;
	LOG_STD=LOG(STD);
	YEAR=YEAR(DATE);
	RENAME STD=STD1;
	LABEL LOG_STD="Log e of STD" STD1="Short-Term departures";
	DROP F7 LTA LTD PA PD STA apr aug dec feb jan jul jun mar may nov oct sep;
RUN;
PROC ARIMA DATA=ARRDEP_ARIMA PLOTS(ONLY)=(SERIES(CORR) RESIDUAL(CORR NORMAL SMOOTH) FORECAST(ALL));
	IDENTIFY VAR=LOG_STD(1,12) NLAG=48 CLEAR;
	ESTIMATE p=(3) Q=(1)(12) NOCONSTANT;
	FORECAST ID=DATE INTERVAL=MONTH PRINTALL LEAD=66 OUT=ARIMA;
RUN; QUIT;
PROC SGPLOT DATA=ARRDEP_ARIMA NOAUTOLEGEND;
	FOOTNOTE ITALIC JUSTIFY=LEFT "Figure 4: Autoregressive Term, Period 3 Quarterly Seasonal Pattern";
	REFLINE 3 6 9 / AXIS=X LABEL=("3 MONTH AR PEAK" "3 MONTH AR PEAK" "3 MONTH AR PEAK") LINEATTRS=(COLOR=BLACK PATTERN=2) LABELLOC=OUTSIDE;
	SERIES X=MOY Y=STD1 / GROUp=YEAR LINEATTRS=(PATTERN=1);
	XAXIS VALUES=(1 TO 12 BY 1);
RUN; FOOTNOTE;
PROC SGPLOT DATA=ARIMA;
	FOOTNOTE ITALIC JUSTIFY=LEFT "Figure 5: Five Year Forecast of Short-Term Departures";
	REFLINE "01JUL2011"d / AXIS=X LABEL=("DATA ENDS") LINEATTRS=(COLOR=BLACK PATTERN=2) LABELLOC=OUTSIDE;
	BAND UPPER=U95 LOWER=L95 X=DATE / FILL OUTLINE TRANSPARENCY=.2 LEGENDLABEL="95% CL";
	SCATTER X=DATE Y=LOG_STD / LEGENDLABEL="ORIGINAL DATA" MARKERATTRS=(SYMBOL=STAR);
	SERIES X=DATE Y=FORECAST / LEGENDLABEL="ARIMA" LINEATTRS=(COLOR=BLACK thickness=2);
	XAXIS GRID OFFSETMIN=0 OFFSETMAX=0 MIN='1JUL2008'd MAX='1JUL2016'd;
	YAXIS GRID OFFSETMIN=0 OFFSETMAX=0 min=12.5 LABEL="Short-Term Departures (LOG Scale)";
	KEYLEGEND / DOWN=3 NOBORDER LOCATION=INSIDE POSITION=TOPLEFT;
RUN; FOOTNOTE;
PROC REG DATA=ARIMA;
	MODEL RESIDUAL= /DW;
RUN;

DATA FINALFORE;
	MERGE ARRDEP_ARIMA ARIMA;
	BY DATE;
	LABEL REG_PRED="ARIMA Forecast";
	FORECAST=EXP(FORECAST+STD*STD/2);
	L95=EXP(L95);
	U95=EXP(U95);
	DROP YEAR STD RESIDUAL MOY LOG_STD;
RUN;
PROC SGPLOT DATA=FINALFORE;
	FOOTNOTE ITALIC JUSTIFY=LEFT "Figure 7: Final Forecasts";
	REFLINE "01JUL2011"d / AXIS=X LABEL=("DATA ENDS") LINEATTRS=(COLOR=BLACK PATTERN=2) LABELLOC=OUTSIDE;
	BAND UPPER=U95 LOWER=L95 X=DATE / FILL TRANSPARENCY=.2 LEGENDLABEL="95% CL";
	SERIES X=DATE Y=FORECAST / LEGENDLABEL="ARIMA" LINEATTRS=(COLOR=BLACK thickness=.1PCT);
	XAXIS GRID OFFSETMIN=0 OFFSETMAX=0;
	YAXIS GRID OFFSETMIN=0 ;
	KEYLEGEND / DOWN=3 NOBORDER LOCATION=INSIDE POSITION=TOPLEFT;
RUN; FOOTNOTE;
PROC SGPLOT DATA=FINALFORE;
	FOOTNOTE ITALIC JUSTIFY=LEFT "Figure 8: Final Forecasts, Date Restricted";
	REFLINE "01JUL2011"d / AXIS=X LABEL=("DATA ENDS") LINEATTRS=(COLOR=BLACK PATTERN=2) LABELLOC=OUTSIDE;
	BAND UPPER=U95 LOWER=L95 X=DATE / FILL TRANSPARENCY=.2 LEGENDLABEL="95% CL";
	SCATTER X=DATE Y=STD1 / LEGENDLABEL="ORIGINAL DATA" MARKERATTRS=(SYMBOL=STAR SIZE=5);
	SERIES X=DATE Y=FORECAST / LEGENDLABEL="ARIMA" LINEATTRS=(COLOR=BLACK thickness=.1PCT);
	XAXIS GRID OFFSETMIN=0 OFFSETMAX=0 MIN='1JUL2007'd MAX='1JUL2016'd;
	YAXIS GRID OFFSETMIN=0 ;
	KEYLEGEND / DOWN=3 NOBORDER LOCATION=INSIDE POSITION=TOPLEFT;
RUN; FOOTNOTE;
ODS RTF CLOSE; ODS GRAPHICS OFF;

LIBNAME TSWORK 'C:\BasicSAS';
OPTIONS NOCENTER PAGESIZE=150 LINESIZE=256;
DATA HOUSEHOLD; SET TSWORK.HOUSEHOLD;
	DATE=INTNX('MONTH','1MAR1982'd, _N_ );
	FORMAT DATE MMYYS.;
	HG_RETAIL_LOG=LOG(HG_RETAIL);
	HG_RETAIL_SQRT=SQRT(HG_RETAIL);
	LABEL HG_RETAIL='Household goods turnover ($millions)'
			HG_RETAIL_LOG='Household goods turnover (LOG)'
			HG_RETAIL_SQRT='Household goods turnover (SQRT)';
RUN;

ODS GRAPHICS ON / RESET border=off HEIGHT=10CM;
ODS RTF FILE="MYFILE.rtf" STYLE=Styles.MYWAY1;
*Series plot and transform;
PROC SGPLOT DATA=HOUSEHOLD NOAUTOLEGEND;
	FOOTNOTE JUSTIFY=LEFT ITALIC "Figure 9: Series Plot"; 
	REFLINE "01sep2008"d / AXIS=X LABEL=("Global FC") LINEATTRS=(COLOR=BLACK PATTERN=2);
	REFLINE "01jul1997"d / AXIS=X LABEL=("Asian FC") LINEATTRS=(COLOR=BLACK PATTERN=2);
	REFLINE "01FEB1990"d / AXIS=X LABEL=("1990s AU Rec.") LINEATTRS=(COLOR=BLACK PATTERN=2) ;
	SERIES X=DATE Y=HG_RETAIL / LEGENDLABEL="Household Goods Retailing";
	XAXIS OFFSETMIN=0 OFFSETMAX=0;
RUN; FOOTNOTE;

PROC SGPLOT DATA=HOUSEHOLD;
	FOOTNOTE JUSTIFY=LEFT ITALIC "Figure 10: Transformation Comparison"; 
	SERIES X=DATE Y=HG_RETAIL_LOG / LINEATTRS=(COLOR=BLACK PATTERN=1);
	SERIES X=DATE Y=HG_RETAIL_SQRT / Y2AXIS LINEATTRS=(COLOR=BLACK PATTERN=3);
	YAXIS MINOFFSET=0 MIN=6 MAX=10;
	Y2AXIS MINOFFSET=0 MIN=10;
	XAXIS OFFSETMIN=0 OFFSETMAX=0;
	KEYLEGEND / NOBORDER DOWN=4 LOCATION=INSIDE POSITION=TOPLEFT;
RUN; FOOTNOTE;

DATA REG_INPUT;
	SET ARIMA;
	MONTH=_N_;
	MONTH_NUMBER=MONTH(DATE);
	IF MONTH_NUMBER = 1 THEN JAN=1; ELSE JAN=0;
	IF MONTH_NUMBER = 2 THEN FEB=1; ELSE FEB=0;
	IF MONTH_NUMBER = 3 THEN MAR=1; ELSE MAR=0;
	IF MONTH_NUMBER = 4 THEN APR=1; ELSE APR=0;
	IF MONTH_NUMBER = 5 THEN MAY=1; ELSE MAY=0;
	IF MONTH_NUMBER = 6 THEN JUN=1; ELSE JUN=0;
	IF MONTH_NUMBER = 7 THEN JUL=1; ELSE JUL=0;
	IF MONTH_NUMBER = 8 THEN AUG=1; ELSE AUG=0;
	IF MONTH_NUMBER = 9 THEN SEp=1; ELSE SEp=0;
	IF MONTH_NUMBER = 10 THEN OCT=1; ELSE OCT=0;
	IF MONTH_NUMBER = 11 THEN NOV=1; ELSE NOV=0;
	LABEL SQUARE='Squared Month';
RUN;
PROC REG DATA=REG_INPUT OUTEST=EST OUTVIF PLOTS(ONLY)=(fit DIAGNOSTICS(STATS=ALL) OBSERVEDBYPREDICTED RESIDUALBYPREDICTED RSTUDENTBYPREDICTED QQPLOT RESIDUALHISTOGRAM COOKSD);
	MODEL HG_RETAIL_LOG = month jan feb mar apr may jun jul aug sep oct nov / SELECTION=STEPWISE DW TOL VIF EDF AIC BIC CP SBC ;
	OUTPUT OUT=REGRESSION RESIDUAL=REG_RES PREDICTED=REG_PRED STDI=STDI LCL=REG_LCL UCL=REG_UCL;
RUN; QUIT; PROC PRINT DATA=EST; RUN;

DATA FORECAST2;
	SET REGRESSION;
	FORECAST=EXP(FORECAST+STD*STD/2);
	L95=EXP(L95);
	U95=EXP(U95);
	REG_PRED=EXP(REG_PRED+STDI*STDI/2);
	REG_LCL=EXP(REG_LCL);
	REG_UCL=EXP(REG_UCL);
RUN;
PROC SGPLOT DATA=REGRESSION;
	FOOTNOTE ITALIC JUSTIFY=LEFT "Figure 11: Fit Testing, Residuals by Date with LOESS";
	WHERE DATE<='1JUL2012'd;
	REFLINE 0 / AXIS=y LINEATTRS=(COLOR=BLACK PATTERN=2);
	LOESS X=DATE Y=REG_RES / MARKERATTRS=(COLOR=BLACK) LINEATTRS=(COLOR=BLACK) ALPHA=.05 CLM LEGENDLABEL="LOESS" NAME="LINE1";
	KEYLEGEND "LINE1" / NOBORDER LOCATION=INSIDE POSITION=BOTTOMLEFT;
RUN; FOOTNOTE;

DATA FORECAST2;
	MERGE HOUSEHOLD FORECAST2;
	RUN;
PROC SGPLOT DATA=FORECAST2;
	FOOTNOTE ITALIC JUSTIFY=LEFT "Figure 12: Five Year Forecast, Date Restricted";
	BAND UPPER=REG_UCL LOWER=REG_LCL X=DATE / outline FILL TRANSPARENCY=.2 LEGENDLABEL="95% CL";
	REFLINE "01oct2011"d / AXIS=X LABEL=("DATA ENDS") LINEATTRS=(COLOR=BLACK PATTERN=2) LABELLOC=OUTSIDE;
	SCATTER X=DATE Y=HG_RETAIL / LEGENDLABEL="ORIGINAL DATA" MARKERATTRS=(SYMBOL=STAR);
	SERIES X=DATE Y=REG_PRED / LEGENDLABEL="REGRESSION";
	XAXIS GRID OFFSETMIN=0 OFFSETMAX=0  MIN='1JUL2008'd MAX='1JUL2016'd;
	YAXIS GRID OFFSETMIN=0 MIN=2000;
	KEYLEGEND / NOBORDER DOWN=4 LOCATION=INSIDE POSITION=TOPLEFT;
RUN; FOOTNOTE;

PROC SGPLOT DATA=FORECAST2;
	FOOTNOTE ITALIC JUSTIFY=LEFT "Figure 13: Full Series with Regression Forecast";
	BAND UPPER=REG_UCL LOWER=REG_LCL X=DATE / FILL LEGENDLABEL="95% CL";
	REFLINE "01oct2011"d / AXIS=X LABEL=("DATA ENDS") LINEATTRS=(COLOR=BLACK PATTERN=2) LABELLOC=OUTSIDE;
	SCATTER X=DATE Y=HG_RETAIL / LEGENDLABEL="ORIGINAL DATA" TRANSPARENCY=.6 MARKERATTRS=(SYMBOL=STAR SIZE=.8PCT);
	SERIES X=DATE Y=REG_PRED / LEGENDLABEL="REGRESSION";
	XAXIS GRID OFFSETMIN=0 OFFSETMAX=0;
	YAXIS GRID OFFSETMIN=0;
	KEYLEGEND / NOBORDER DOWN=4 LOCATION=INSIDE POSITION=TOPLEFT;
RUN; FOOTNOTE;

DATA HOUSEHOLD; SET TSWORK.HOUSEHOLD;
	DATE=INTNX('MONTH','1MAR1982'd, _N_ );
	FORMAT DATE MMYYS.;
	HG_RETAIL_LOG=LOG(HG_RETAIL);
	IF _N_=219 THEN HG_RETAIL_LOG=mean(7.6985281383,7.4838066877);
	IF _N_=48 THEN HG_RETAIL_LOG=mean(6.6096187486,6.759603238);
	LABEL HG_RETAIL='Household goods turnover ($millions)'
			HG_RETAIL_LOG='Household goods turnover (LOG)';
RUN;
PROC ARIMA DATA=HOUSEHOLD PLOTS=ALL;
	IDENTIFY VAR=HG_RETAIL_LOG(1,12) NLAG=24 CLEAR;
	ESTIMATE p=(1)(3,6) Q=(1)(12) NOCONSTANT;
	OUTLIER;
	FORECAST ID=DATE INTERVAL=MONTH PRINTALL LEAD=64 OUT=ARIMA;
PROC SGPLOT DATA=ARIMA;
	FOOTNOTE ITALIC JUSTIFY=LEFT "Figure 15: Fit Testing, Residuals by Date with LOESS";
	WHERE DATE<='1JUL2012'd;
	REFLINE 0 / AXIS=y LINEATTRS=(COLOR=BLACK PATTERN=2);
	LOESS X=DATE Y=RESIDUAL / MARKERATTRS=(COLOR=BLACK) LINEATTRS=(COLOR=BLACK) ALPHA=.05 CLM LEGENDLABEL="LOESS" NAME="LINE1";
	KEYLEGEND "LINE1" / NOBORDER LOCATION=INSIDE POSITION=BOTTOMRIGHT;
RUN; FOOTNOTE;
DATA FORECAST1;
	SET ARIMA;
	FORECAST=EXP(FORECAST+STD*STD/2);
	L95=EXP(L95);
	U95=EXP(U95);
RUN;
DATA FORECAST1;
	MERGE HOUSEHOLD FORECAST1;
	RUN;
PROC SGPLOT DATA=FORECAST1;
	FOOTNOTE ITALIC JUSTIFY=LEFT "Figure 16: ARIMA Forecast, Date Restricted";
	REFLINE "01oct2011"d / AXIS=X LABEL=("DATA ENDS") LINEATTRS=(COLOR=BLACK PATTERN=2) LABELLOC=OUTSIDE;
	BAND UPPER=U95 LOWER=L95 X=DATE / outline FILL TRANSPARENCY=.2 LEGENDLABEL="95% CL";
	SCATTER X=DATE Y=HG_RETAIL / LEGENDLABEL="ORIGINAL DATA" MARKERATTRS=(SYMBOL=star SIZE=2pct);
	SERIES X=DATE Y=FORECAST / LEGENDLABEL="ARIMA";
	XAXIS GRID OFFSETMIN=0 OFFSETMAX=0 MIN='1JUL2008'd MAX='1JUL2016'd;
	YAXIS GRID OFFSETMIN=0 MIN=2000;
	KEYLEGEND / NOBORDER DOWN=4 LOCATION=INSIDE POSITION=TOPLEFT;
RUN; FOOTNOTE;
PROC SGPLOT DATA=FORECAST1;
	FOOTNOTE ITALIC JUSTIFY=LEFT "Figure 17: Full Series with ARIMA Forecast";
	REFLINE "01oct2011"d / AXIS=X LABEL=("DATA ENDS") LINEATTRS=(COLOR=BLACK PATTERN=2) LABELLOC=OUTSIDE;
	BAND UPPER=U95 LOWER=L95 X=DATE / FILL TRANSPARENCY=.2 LEGENDLABEL="95% CL";
	SCATTER X=DATE Y=HG_RETAIL / LEGENDLABEL="ORIGINAL DATA" TRANSPARENCY=.6 MARKERATTRS=(SYMBOL=STAR SIZE=.8PCT);
	SERIES X=DATE Y=FORECAST / LEGENDLABEL="ARIMA";
	XAXIS GRID OFFSETMIN=0 OFFSETMAX=0 ;
	YAXIS GRID OFFSETMIN=0;
	KEYLEGEND / NOBORDER DOWN=4 LOCATION=INSIDE POSITION=TOPLEFT;
RUN; FOOTNOTE;
RUN; QUIT;
PROC REG DATA=ARIMA;
	MODEL RESIDUAL= / DW;
RUN; QUIT;

PROC AUTOREG DATA=REG_INPUT plot=wn;
	MODEL HG_RETAIL_LOG = month jan feb mar apr may jun jul aug sep oct nov / p=3 backstep MAXITER=1000 ;
	OUTPUT OUT=AUTOREGRESSION RESIDUAL=AUTREG_RES PREDICTED=AUTOREG_PRED LCLM=AUTOREG_LCLM UCLM=AUTOREG_UCLM;
RUN;
PROC SGPLOT DATA=AUTOREGRESSION;
	FOOTNOTE ITALIC JUSTIFY=LEFT "test plot: Full Series with Regression Forecast";
	WHERE DATE<='1JUL2012'd;
	REFLINE 0 / AXIS=y LINEATTRS=(COLOR=BLACK PATTERN=2);
	LOESS X=DATE Y=AUTREG_RES / MARKERATTRS=(COLOR=BLACK) LINEATTRS=(COLOR=BLACK) ALPHA=.05 CLM LEGENDLABEL="LOESS" NAME="LINE1";
	KEYLEGEND "LINE1" / NOBORDER LOCATION=INSIDE POSITION=BOTTOMRIGHT;
RUN; FOOTNOTE;
DATA AUTOREGRESSION2;
	MERGE AUTOREGRESSION REGRESSION;
RUN;
DATA A;
	SET ARIMA;
	FORECAST=EXP(FORECAST+STD*STD/2);
	L95=EXP(L95);
	U95=EXP(U95);
	KEEP FORECAST L95 U95 DATE;
RUN;
DATA B;
	SET REGRESSION;
	REG_PRED=EXP(REG_PRED+STDI*STDI/2);
	REG_LCL=EXP(REG_LCL);
	REG_UCL=EXP(REG_UCL);
	KEEP REG_PRED REG_LCL REG_UCL DATE;
RUN;
DATA C;
	SET AUTOREGRESSION2;
	AUTOREG_PRED=EXP(AUTOREG_PRED+STDI*STDI/2);
	AUTOREG_LCLM=EXP(AUTOREG_LCLM);
	AUTOREG_UCLM=EXP(AUTOREG_UCLM);
	KEEP AUTOREG_PRED AUTOREG_LCLM AUTOREG_UCLM DATE;
RUN;
DATA MASTER;
	MERGE A B C HOUSEHOLD;
	BY DATE;
RUN;
PROC SGPLOT DATA=MASTER;
	FOOTNOTE ITALIC JUSTIFY=LEFT "Figure 18: Five Year Forecast, Date Restricted";
	BAND UPPER=AUTOREG_UCLM LOWER=AUTOREG_LCLM X=DATE / OUTLINE FILL TRANSPARENCY=.2 LEGENDLABEL="95% CL";
	REFLINE "01oct2011"d / AXIS=X LABEL=("DATA ENDS") LINEATTRS=(COLOR=BLACK PATTERN=2) LABELLOC=OUTSIDE;
	SCATTER X=DATE Y=HG_RETAIL / LEGENDLABEL="ORIGINAL DATA" MARKERATTRS=(SYMBOL=STAR);
	SERIES X=DATE Y=AUTOREG_PRED / LEGENDLABEL="REGRESSION";
	XAXIS GRID OFFSETMIN=0 OFFSETMAX=0  MIN='1JUL2008'd MAX='1JUL2016'd;
	YAXIS GRID OFFSETMIN=0 MIN=2000;
	KEYLEGEND / NOBORDER DOWN=4 LOCATION=INSIDE POSITION=TOPLEFT;
RUN; FOOTNOTE;

PROC SGPLOT DATA=MASTER;
	FOOTNOTE ITALIC JUSTIFY=LEFT "Figure 19: Forecast Comparison";
	SERIES X=DATE Y=REG_PRED / LEGENDLABEL="Regression" lineattrs=(color=BLACK pattern=3);
	SERIES X=DATE Y=AUTOREG_PRED / LEGENDLABEL="Autoregression" lineattrs=(color=BLACK pattern=1) ;
	SERIES X=DATE Y=FORECAST / LEGENDLABEL="SARIMA" lineattrs=(color=black pattern=2);
	REFLINE "01oct2011"d / AXIS=X LABEL=("DATA ENDS") LINEATTRS=(COLOR=BLACK PATTERN=2) LABELLOC=OUTSIDE;
	SCATTER X=DATE Y=HG_RETAIL / LEGENDLABEL="ORIGINAL DATA" MARKERATTRS=(SYMBOL=STAR);
	YAXIS GRID OFFSETMIN=0 MIN=2000 LABEL="Household goods turnover ($millions)";
	XAXIS GRID OFFSETMIN=0 OFFSETMAX=0  MIN='1JUL2008'd MAX='1JUL2016'd;
	KEYLEGEND / NOBORDER DOWN=4 LOCATION=INSIDE POSITION=TOPLEFT;
RUN; FOOTNOTE;
ODS RTF CLOSE; ODS GRAPHICS OFF;

LIBNAME TSWORK 'C:\BasicSAS';
OPTIONS NOCENTER PAGESIZE=150 LINESIZE=256;
DATA NEW_ARRDEP;
	SET TSWORK.ARRDEP;
	DATE=INTNX('MONTH','1dec1975'd, _N_ );
	FORMAT DATE MMYYS.;
	LOG_STD=LOG(STD);
	LOG_STA=LOG(STA);
	RENAME STD=STD1; 
	LABEL LOG_STD="Log e of STD" LOG_STA="Log e of STA" STD1="Short-Term departures";
	DROP F7 LTA LTD PA PD;
RUN;

ODS GRAPHICS ON / RESET border=off HEIGHT=15CM;
ODS RTF FILE="MYFILE.rtf" STYLE=Styles.MYWAY1;

PROC SGPLOT DATA=NEW_ARRDEP;
	FOOTNOTE ITALIC JUSTIFY=LEFT "Figure 20: Short-Term Departures and Arrivals";
	SERIES X=DATE Y=STD1 / LINEATTRS=(COLOR=RED);
	SERIES X=DATE Y=STA / LINEATTRS=(COLOR=BLACK);
	XAXIS GRID OFFSETMIN=0 OFFSETMAX=0;
	YAXIS GRID OFFSETMIN=0 OFFSETMAX=0 LABEL="Short-Term Departures & Arrivals";
	KEYLEGEND / DOWN=2 NOBORDER LOCATION=INSIDE POSITION=TOPLEFT;
RUN; FOOTNOTE;
PROC SGPLOT DATA=NEW_ARRDEP;
	FOOTNOTE ITALIC JUSTIFY=LEFT "Figure 21: STA/STD LAG";
	SERIES X=DATE Y=STD / LINEATTRS=(COLOR=RED);
	SERIES X=DATE Y=STA / LINEATTRS=(COLOR=BLACK);
	XAXIS GRID OFFSETMIN=0 OFFSETMAX=0 MIN='1JUL2007'd MAX='1JUL12010'd;
	YAXIS GRID OFFSETMIN=0 OFFSETMAX=0 LABEL="Short-Term Departures & Arrivals";
	KEYLEGEND / DOWN=2 NOBORDER LOCATION=INSIDE POSITION=TOPLEFT;
RUN; FOOTNOTE;

PROC ARIMA DATA=NEW_ARRDEP PLOTS(ONLY)=(SERIES(CORR) RESIDUAL(CORR NORMAL SMOOTH) FORECAST(ALL));
	IDENTIFY VAR=LOG_STA(1,12) NLAG=24 CLEAR;
	ESTIMATE p=(1,2) Q=(12) NOCONSTANT;
	FORECAST ID=DATE INTERVAL=MONTH PRINTALL LEAD=36 OUT=ARIMA;
RUN; QUIT;
PROC REG DATA=ARIMA;
	MODEL RESIDUAL= /DW;
RUN;
DATA ARIMASTA;
	MERGE NEW_ARRDEP ARIMA;
	BY DATE;
	FORECAST=EXP(FORECAST+STD*STD/2);
	L95=EXP(L95);
	U95=EXP(U95);
	DROP STD RESIDUAL MOY LOG_STD;
RUN;
PROC SGPLOT DATA=ARIMASTA;
	FOOTNOTE ITALIC JUSTIFY=LEFT "Figure 23: Three Year Forecast of Short-Term Arrivals";
	REFLINE "01JUL2011"d / AXIS=X LABEL=("DATA ENDS") LINEATTRS=(COLOR=BLACK PATTERN=2) LABELLOC=OUTSIDE;
	BAND UPPER=U95 LOWER=L95 X=DATE / FILL OUTLINE TRANSPARENCY=.2 LEGENDLABEL="95% CL";
	SCATTER X=DATE Y=STA / LEGENDLABEL="ORIGINAL DATA" MARKERATTRS=(SYMBOL=STAR);
	SERIES X=DATE Y=FORECAST / LEGENDLABEL="ARIMA" LINEATTRS=(COLOR=BLACK thickness=2);
	XAXIS GRID OFFSETMIN=0 OFFSETMAX=0 MIN='1jan2009'd MAX='1jan2014'd;
	YAXIS GRID OFFSETMIN=0 OFFSETMAX=0 LABEL="Short-Term Arrivals";
	KEYLEGEND / DOWN=3 NOBORDER LOCATION=INSIDE POSITION=TOPLEFT;
RUN; FOOTNOTE;

DATA NEW2_ARRDEP;
	set TSWORK.ARRDEP;
	BY DATE;
	DATE=INTNX('MONTH','1dec1975'd, _N_ );
	FORMAT DATE MMYYS.;
	LOG_STD=LOG(STD);
	LOG_STA=LOG(STA);
	LOG_STDlag1=lag1(LOG_STD);
	LOG_STDlag2=lag2(LOG_STD);
	LOG_STDlag3=lag3(LOG_STD);
	LOG_STDlag4=lag4(LOG_STD);
	LABEL LOG_STD="Log e of STD" LOG_STA="Log e of STA";
	DROP F7 LTA LTD PA PD;
RUN;
PROC AUTOREG DATA=NEW2_ARRDEP;
	MODEL LOG_STA = LOG_STD LOG_STDlag1 LOG_STDlag3 LOG_STDlag4 / NLAG=(1 4 12) MAXITER=1000;
	OUTPUT OUT=AUTOREGRESSION RESIDUAL=AUTREG_RES PREDICTED=AUTOREG_PRED LCLM=AUTOREG_LCLM UCLM=AUTOREG_UCLM;
RUN;

*Autoreg Forecasting;
DATA ARSET_ARRDEP;
	SET TSWORK.ARRDEP;
	DATE=INTNX('MONTH','1dec1975'd, _N_ );
	FORMAT DATE MMYYS.;
	LOG_STD=LOG(STD);
	LABEL LOG_STD="Log e of STD" ;
	DROP F7 LTA LTD PA PD STA moy apr aug dec feb jan jul jun mar may nov oct sep;
RUN;
PROC ARIMA DATA=ARSET_ARRDEP PLOTS(ONLY)=(SERIES(CORR) RESIDUAL(CORR NORMAL SMOOTH) FORECAST(ALL));
	IDENTIFY VAR=LOG_STD(1,12) NLAG=48 CLEAR;
	ESTIMATE p=(3) Q=(1)(12) NOCONSTANT;
	FORECAST ID=DATE INTERVAL=MONTH PRINTALL LEAD=36 OUT=ARIMA_STD;
RUN; QUIT;
DATA ARIMA_STD;
	SET ARIMA_STD;
	FORECAST=EXP(FORECAST+STD*STD/2);
	IF _N_<=427 THEN DELETE;
	DROP STD L95 U95 RESIDUAL LOG_STD;
	RENAME FORECAST=STD;
RUN;
DATA ARIMA_STD;
	SET ARIMA_STD;
	STD=ROUND(STD,1);
	LABEL STD="Short-Term departures";
RUN;
DATA AUTOREG_F0;
 SET TSWORK.ARRDEP;
  DATE=INTNX('MONTH','1dec1975'd, _N_ );
  FORMAT DATE MMYYS.;
  DROP F7 LTA LTD PA PD month moy apr aug dec feb jan jul jun mar may nov oct sep;
RUN;
DATA AUTOREG_F1;
	SET AUTOREG_F0 ARIMA_STD;
	LOG_STA=LOG(STA);
	LOG_STD=LOG(STD);
	LOG_STDlag1=lag1(LOG_STD);
	LOG_STDlag3=lag3(LOG_STD);
	LOG_STDlag4=lag4(LOG_STD);
RUN;
PROC AUTOREG DATA=AUTOREG_F1;
	MODEL LOG_STA = LOG_STD LOG_STDlag1 LOG_STDlag3 LOG_STDlag4 / NLAG=(1 4 12) MAXITER=1000;
	OUTPUT OUT=AUTOREGRESSION RESIDUAL=AUTREG_RES PREDICTED=AUTOREG_PRED LCLM=AUTOREG_LCLM UCLM=AUTOREG_UCLM;
RUN; QUIT; RUN;
DATA AUTOREG_FORECAST;
	SET AUTOREGRESSION;
	AUTOREG_PRED=EXP(AUTOREG_PRED);
	AUTOREG_LCLM=EXP(AUTOREG_LCLM);
	AUTOREG_UCLM=EXP(AUTOREG_UCLM);
	DROP STD RESIDUAL MOY LOG_STD LOG_STDlag1 LOG_STDlag2 LOG_STDlag3 LOG_STDlag4;
RUN;
PROC SGPLOT DATA=AUTOREG_FORECAST;
	FOOTNOTE ITALIC JUSTIFY=LEFT "Figure 24: Three Year Forecast of Short-Term Arrivals";
	REFLINE "01JUL2011"d / AXIS=X LABEL=("DATA ENDS") LINEATTRS=(COLOR=BLACK PATTERN=2) LABELLOC=OUTSIDE;
	BAND UPPER=AUTOREG_UCLM LOWER=AUTOREG_LCLM X=DATE / FILL OUTLINE TRANSPARENCY=.2 LEGENDLABEL="95% CL";
	SCATTER X=DATE Y=STA / LEGENDLABEL="ORIGINAL DATA" MARKERATTRS=(SYMBOL=STAR);
	SERIES X=DATE Y=AUTOREG_PRED / LEGENDLABEL="Dynamic Regression" LINEATTRS=(COLOR=BLACK thickness=2);
	XAXIS GRID OFFSETMIN=0 OFFSETMAX=0 MIN='1jan2009'd MAX='1jan2014'd;
	YAXIS GRID OFFSETMIN=0 OFFSETMAX=0 LABEL="Short-Term Arrivals";
	KEYLEGEND / DOWN=3 NOBORDER LOCATION=INSIDE POSITION=TOPLEFT;
RUN; FOOTNOTE;
